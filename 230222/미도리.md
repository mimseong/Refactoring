# 02 리팩터링 원칙

## 2.1 리팩터링 정의
- 리팩터링: 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법
- 리팩터링하다: 소프트웨어의 겉보기 동작은 그대로 유지한 채, 여러가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하다.

> 동작을 유지하는 작은 단계를 순차적으로 거쳐서 큰 변화를 만들어내는 일.

- 재구성(restructuring): 코드베이스를 정리하거나 구조를 바꾸는 것
  - 리팩터링은 재구성의 한 형태.

- 리팩터링의 목적: 코드를 이해, 수정하기 쉽게 만드는 것.
  - __리팩터링 전과 후의 코드는 똑같이 동작해야 한다.__

## 2.2 두개의 모자
‘기능 추가’ vs ‘리팩터링’

- 기능을 추가할 때는 기존코드는 건드리지 않고 기능 추가만!
- 리팩터링할 때는 기능 추가는 절대 하지 않는다!

(이 부분도 익혀야할 것이라고 생각되는게, 기능 추가를 하다가도 리팩터링하고 싶은 게 있어서 자꾸 딴길로 새는 경우가 있다. 어떤 작업을 할 때는 당장 목표로하는 것만 진행하고 마무리되면 다른 작업을 진행하자.)

## 2.3 리팩터링 하는 이유

1. 리팩터링하면 소프트웨어 설계가 좋아진다.</br>
    - 아키텍쳐를 이해하지 못한 채 단기 목표만을 위해 코드를 수정하다보면 구조가 무너지기 쉽다. 
      - 코드만 봐서는 설계를 파악하기 어려워진다.
      - 코드가 길고 중복이 많을수록 실수할 확률이 커지고 이해해야할 코드의 양이 늘어난다.
    - 중복코드를 제거하면 모든 코드가 언제나 고유한 일을 수행함을 보장할 수 있다. (바람직한 설계)</br>

2.  리팩터링하면 소프트웨어를 이해하기 쉬워진다.</br>
    - 프로그램을 동작시키는데만 열중하면 다른 개발자에 대한 배려를 하지 못함.
    - 꼭 다른 사람이 아니라 나 자신을 위한 배려일 수도?
      - 작성한 코드를 모두 기억하고 있지는 않기 때문에 나중에 다시 이해할 나를 위한 배려

3.  버그를 쉽게 찾을 수 있다.</br>
	  - 리팩터링을하면 코드가 하는 일을 깊이 파악하게 되면서 버그를 찾기 더 쉬워진다.

4. 프로그래밍 속도를 높일 수 있다.</br>
    - 코드베이스가 늘어날수록 새로운 기능 추가하는데 시간이 오래 걸린다. 리팩터링을 하면 개발 시간이 줄어들 수 있다.
      - 나쁜설계: 기능이 누적될 수록 개발 속도 저하
      - 좋은설계: 기능이 누적되어도 개발 속도 비교적 빠름
        - 내부설계가 잘 되면(모듈화가 잘 되면) 전체 코드 중 일부만 이해하면 된다. 

    - 지구력 가설: 내부 설계에 심혈을 기울이면 소프트웨어의 지구력이 높아져서 빠르게 개발할 수 있는 상태를 오래 지속한다…는 가설

## 2.4 언제 리팩터링해야할까?

> 3의 법칙
> 1.  그냥 한다.
> 2. 비슷한 일을 두번째로 하게되면 당황스럽지만 일단 그냥 한다.
> 3. 비슷한 일을 세번째 하게되면 리팩터링한다.
 
#### 💛 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기
- 기능을 새로 추가하기 직전 바꿀 수 있을 만한것 찾아보기
- 함수는 복제하지 않고 **함수 매개변수화하기** 활용
- 중복된 코드에서 버그가 발생했다면 하나로 합치는 것이 좋음

#### 💛 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기
- 코드 파악 우선
- 코드를 이해하며 리팩터링 해보기 (함수 나누기, 이름 바꾸기 등..)

#### 💛 쓰레기 줍기 리팩터링
- 간단히 수정할 수 있는 것은 바로 수정
- 시간이 걸릴 것 같으면 메모해둔 후, 나중에 처리
- 시간이 걸리더라도 조금이나마 개선해두는 것이 좋다.

#### 💛 계획된 리팩터링과 수시로 하는 리팩터링
- 리팩터링 시간을 따로 잡아두지 않고, 기능을 추가하거나 버그를 잡을 때 수시로 리팩터링 한다.
- 계획된 리팩터링은 최소한으로

#### 💛 오래 걸리는 리팩터링
- 팀 전체가 진행하는 대규모 리팩터링
	- 보다는 주어진 문제를 몇 주에 걸쳐 조금씩 해결해가는 편이 효과적.
	- ex) 라이브러리 교체를 할 경우, 기존 라이브러리와 새 라이브러리를 포용하는 추상 인터페이스를 먼저 마련하고 점차 리팩터링

#### 💛 코드 리뷰에 리팩터링 활용하기
- 코드 리뷰를 하면 다른 사람의 아이디어를 얻을 수 있다.
- 짝 프로그래밍이 효과적

#### 💛 관리자에게는 뭐라고 말해야할까?
- 관리자가 기술을 잘 모른다면 "말하지 말라"

#### 💛 리팩터링하지 말아야할 때
- 외부 API 다루듯 호출해서 쓰는 코드
- 처음부터 새로 작성하는 게 쉬울 때


## 2.5 리팩터링 시 고려할 문제

### 새 기능 개발 속도 저하
- 리팩터링의 궁극적 목표는 개발 속도 높이기
- 리팩터링의 본질은 코드를 예쁘게 하는 것이 아닌 경제적인 목적

### 코드 소유권
- 코드 소유권이 나뉘어있으면 리팩터링에 방해가 된다.

### 브랜치
- 팀원마다 브랜치를 하나씩 맡아서 작업 -> 마스터 브랜치에 통합하는 방식
	- 독립 브랜치로 작업하는 기간이 길어질수록 마스터로 통합하기 어려워진다.
- 기능별 브랜치의 통합 주기를 짧게 해야한다.
	- 지속적 통합(CI): 모든 팀원이 하루에 한번은 마스터와 통합

### 테스팅
- 리팩터링 시 실수를 면하려면 오류를 빨리 찾을 수 있어야한다.
	- 코드의 다양한 측면을 테스트하는 테스트 스위트 필요
	- 리팩터링하기 위해서는 테스트 코드를 마련해야한다.
	- 리팩터링 과정에서 버그가 생길 것 같은 불안감 해소 가능


### 레거시 코드
레거시 코드는 테스트가 없는 경우가 많다.
- 테스트 보강
	- 테스트를 추가할 틈새를 찾아 테스트코드를 작성하자.


### 데이터베이스
- 단계를 쪼개 마이그레이션하는 것이 좋다.


## 2.6 리팩터링, 아키텍처, 애그니(YAGNI)
- 기존 관점: 코드가 작성된 후에는 아키텍처를 바꿀 수 없다.
	- 소프트웨어 요구사항을 코딩 전에 모두 파악해야한다. (실현 불가능)
		- 유연성 매커니즘 추가해놓기: 범용적으로 사용될 것 같은 함수는 여러 시나리오에 대응하기 위한 매개변수를 추가해놓는다..
			- 당장 쓰지 않는데 너무 복잡해질 수 있다.
			- 유연성 매커니즘을 잘못 구현할 때가 있다.
- 현재 관점: 코드를 작성한 후에도 리팩터링을 통해 아키텍처를 변경할 수 있다.
	- 간결한 설계, 점진적 설계, YAGNI(you aren't going to need it, **필요 없을 거다**)
		- 현재까지의 요구사항만 파악해 소프트웨어를 구축한다.
		- 요구사항이 추가되면 그에 맞는 아키텍처로 리팩터링한다.
		- 복잡도를 높일 수 있는 유연성 매커니즘은 반드시 검증을 거친 후 추가한다.

## 2.7 리팩터링과 소프트웨어 개발 프로세스
- 팀이 따르는 실천법에 따라 리팩터링의 효과가 크게 달라진다.
- 자가 테스트 코드, 지속적 통합, 리팩터링의 세 기법은 강력한 시너지 효과를 발휘한다.
- 이 세가지는 YAGNI의 토대이면서, YAGNI로 인해 리팩터링이 더 쉬워진다.
	- 복잡한 유연성 메커니즘을 갖춘 시스템보다 단순한 시스템이 리팩터링하기 쉽다.


## 2.8 리팩터링과 성능
- 리팩터링을 하면 성능이 나빠질까?	
	- 느려질 수도 있다. 하지만, **성능 개선을 쉽게 하기 위해서는 리팩터링이 필요**하다.
- 대부분의 프로그램은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다.
	- **코드 전체를 최적화하는 것의 의미가 없다**.
- 성능 최적화에 돌입하기 전까지는 성능 신경쓰지 않고 코드를 다루기 쉽게 만드는 작업을 한다.
	- 성능 최적화 단계가 되면 다음 단계를 따른다.
		- 1. 프로그램을 분석하여 시간과 공간을 많이 잡아먹는 지점 알아내기
		- 2. 그 부분을 개선

## 2.9 리팩터링의 유래
- 리팩터링의 선구자: 워드 커닝햄, 켄트 벡

## 2.10 리팩터링 자동화
- 자동 리팩터링을 지원하는 도구 등장
	- VS Code (https://code.visualstudio.com/docs/editor/refactoring)
- 자동 리팩터링의 원칙
	- 정적 타입 언어라면 안전하게 리팩터링을 할 수 있는 경우가 많다.
	- IDE는 코드를 구문트리로 분석해서 리팩터링한다.

## 2.11 더 알고 싶다면
- 리팩터링 연습에 주력하고 싶다면
	- 리팩터링 워크북(윌리엄 웨이크)
- 특정 디자인 패턴으로 리팩터링 하기 위한 기법
	- 패턴을 활용한 리팩터링(조슈아 케리에프스키)
- 특정 분야에 특화된 리팩토링
	- 리팩토링 데이터베이스(스캇 엠블러, 프라모드 사달게)
	- 리팩토링 HTML(엘리엇 러스티 해롤드)
- 테스트 커버리지가 낮은 레거시 코드 리팩터링
	- 레거시 코드 활용 전략(마이클 페더스)

- 리팩터링 2판 지원 사이트(https://github.com/WegraLee/Refactoring)
- 리팩터링 웹사이트 (https://refactoring.com/)

